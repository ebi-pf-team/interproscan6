name: Unit Tests

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'     
        required: true
        default: 'warning'
      tags:
        description: 'Manual execution of unit tests'

  push:
    branches: [ main ]
    paths:
      - .github/workflows/unit-tests.yml

  pull_request:
    branches: [ main ]
    paths:
      - interproscan/scripts
      - interproscan/modules
      - interproscan/subworkflows
      - tests
      - nextflow.config
      - interproscan.nf
      - .github/workflows/unit-tests.yml

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    continue-on-error: true

    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Set up Java
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: Remove unnecessary files
      run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      
    - name: Install dependencies
      shell: bash -l {0}
      run: |
        pip install -r utilities/requirements-dev.txt
        pip install nextflow
        pip install nextflow pytest pytest-cov
        bash utilities/install_nf-test.sh
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ hashFiles('utilities/docker/unit_tests/Dockerfile') }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build and load Docker image
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./utilities/docker/unit_tests/Dockerfile
        load: true
        tags: interproscan6:latest
        cache-from: |
          type=local,src=/tmp/.buildx-cache
          type=gha
        cache-to: |
          type=local,dest=/tmp/.buildx-cache,mode=max
          type=gha,mode=max

    - name: NF-Test subworkflows tests
      shell: bash -l {0}
      run: |
        export PATH=$PATH:$GITHUB_WORKSPACE/nf-test
        ./nf-test test tests/unit_tests/subworkflows/pre_checks/
        ./nf-test test tests/unit_tests/subworkflows/sequence_precalc/
        ./nf-test test tests/unit_tests/subworkflows/aggregate_results/
        ./nf-test test tests/unit_tests/subworkflows/xrefs/

    - name: NF-Test process tests
      shell: bash -l {0}
      run: |
        export PATH=$PATH:$GITHUB_WORKSPACE/nf-test
        ./nf-test test tests/unit_tests/modules/parse_sequence/
        ./nf-test test tests/unit_tests/modules/hmmer/runner/
        ./nf-test test tests/unit_tests/modules/hmmer/parser/
        ./nf-test test tests/unit_tests/modules/hmmer/post_processing/
        ./nf-test test tests/unit_tests/modules/hmmer/filter/
        ./nf-test test tests/unit_tests/modules/xref/entries/
        ./nf-test test tests/unit_tests/modules/xref/goterms/
        ./nf-test test tests/unit_tests/modules/xref/pathways/
        ./nf-test test tests/unit_tests/modules/xref/paint_annotations/
        ./nf-test test tests/unit_tests/modules/output/aggregate_parse_seqs/
        ./nf-test test tests/unit_tests/modules/output/write_results/

    - name: PY-Test scripts tests
      shell: bash -l {0}
      run: |
        python -m pytest tests/unit_tests -v --cov=interproscan/scripts --cov-report xml:.coverage.xml

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4.0.1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
